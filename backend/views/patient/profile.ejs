
        <!-- Include Patient Navbar -->
        <%- include('partials/patient_navbar.ejs') %>
        
        <main>
            <!-- Profile Header -->
            <section class="profile-header">
                <div class="profile-picture">
                    üë§
                </div>
                <div class="profile-info">
                    <% if (personalInfo) { %>
                        <h1 class="profile-name"><%= personalInfo.fullName %></h1>
                        <p class="profile-meta">Patient since <%- new Date().toLocaleDateString('en-US', { month: 'long', year: 'numeric' }) %></p>
                    <% } else { %>
                        <h1 class="profile-name">Welcome!</h1>
                        <p class="profile-meta">Complete your profile to get started</p>
                    <% } %>
                    <span class="profile-id">ID: PT-<%= patientId %></span>
                </div>
            </section>

            <!-- Profile Content -->
            <section class="profile-content">
                <!-- Personal Information -->
                <div class="info-card">
                    <div class="card-header">
                        <h3>üìã Personal Information</h3>
                        <button class="edit-btn" id="editPersonalBtn">
                            ‚úèÔ∏è Edit
                        </button>
                    </div>
                    <div class="info-items">
                        <% if (personalInfo) { %>
                            <div class="info-item">
                                <span class="info-label">Full Name:</span>
                                <span class="info-value"><%= personalInfo.fullName %></span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Phone:</span>
                                <span class="info-value"><%= personalInfo.phoneNumber %></span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Date of Birth:</span>
                                <span class="info-value"><%= new Date(personalInfo.dateOfBirth).toLocaleDateString() %></span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Gender:</span>
                                <span class="info-value"><%= personalInfo.gender %></span>
                            </div>
                            <% if (personalInfo.address) { %>
                                <div class="info-item">
                                    <span class="info-label">Address:</span>
                                    <span class="info-value"><%= personalInfo.address %></span>
                                </div>
                            <% } %>
                            <% if (personalInfo.emergencyContact) { %>
                                <div class="info-item">
                                    <span class="info-label">Emergency Contact:</span>
                                    <span class="info-value"><%= personalInfo.emergencyContact %></span>
                                </div>
                            <% } %>
                        <% } else { %>
                            <div class="info-item">
                                <span class="info-label" style="color: #e74c3c;">Personal information not completed</span>
                                <span class="info-value" style="color: #e74c3c;">Please complete your profile</span>
                            </div>
                        <% } %>
                    </div>
                </div>

                <!-- Medical Information -->
                <div class="info-card">
                    <div class="card-header">
                        <h3>üè• Medical Information</h3>
                        <button class="edit-btn" id="editMedicalBtn">
                            ‚úèÔ∏è Edit
                        </button>
                    </div>
                   <div class="info-items">
    <% if (medicalInfo && (medicalInfo.bloodType || medicalInfo.allergies || medicalInfo.height || medicalInfo.weight || medicalInfo.chronicConditions)) { %>
        <% if (medicalInfo.bloodType) { %>
            <div class="info-item">
                <span class="info-label">Blood Type:</span>
                <span class="info-value"><%= medicalInfo.bloodType %></span>
            </div>
        <% } %>
        <% if (medicalInfo.allergies) { %>
            <div class="info-item">
                <span class="info-label">Allergies:</span>
                <span class="info-value"><%= medicalInfo.allergies %></span>
            </div>
        <% } %>
        <% if (medicalInfo.height) { %>
            <div class="info-item">
                <span class="info-label">Height:</span>
                <span class="info-value"><%= medicalInfo.height %> cm</span>
            </div>
        <% } %>
        <% if (medicalInfo.weight) { %>
            <div class="info-item">
                <span class="info-label">Weight:</span>
                <span class="info-value"><%= medicalInfo.weight %> kg</span>
            </div>
        <% } %>
        <% if (medicalInfo.chronicConditions) { %>
            <div class="info-item">
                <span class="info-label">Chronic Conditions:</span>
                <span class="info-value"><%= medicalInfo.chronicConditions %></span>
            </div>
        <% } %>
    <% } else { %>
        <div class="info-item">
            <span class="info-label" style="color: #666;">No medical information added</span>
            <span class="info-value" style="color: #666;">Add your medical details</span>
        </div>
    <% } %>
</div>
                </div>

                <!-- Recent Consultations -->
                <div class="info-card recent-consultations">
                    <div class="card-header">
                        <h3>üìÖ Recent Consultations</h3>
                    </div>
                    <div class="consultation-list">
                        <div class="consultation-item upcoming">
                            <div class="consultation-icon">üìã</div>
                            <div class="consultation-content">
                                <h4>Complete Your Profile</h4>
                                <p>Setup your personal information to start using MediDiag</p>
                            </div>
                            <div class="consultation-time"><%= new Date().toLocaleDateString() %></div>
                            <span class="consultation-status status-upcoming">Pending</span>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="quick-actions">
                    <button class="action-btn" id="editProfileBtn">
                        ‚úèÔ∏è Edit Profile
                    </button>
                    <button class="action-btn" id="chatbotBtn" onclick="window.location.href='/patient/chatbot?patientId=<%= patientId %>'">
                        üí¨ Start ChatBot
                    </button>
                </div>
            </section>
        </main>

        <!-- Include Patient Footer -->
        <%- include('./partials/patient_footer.ejs') %>
    </div>

   <!-- First Login Modal Wizard - This pops up automatically on first login -->
<% if (isFirstLogin) { %>
    <div class="modal-overlay first-login-modal active" id="firstLoginModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üëã Welcome to MediDiag!</h2>
            </div>
            <p>Please complete your profile to get started with our services</p>
            
            <form id="firstLoginForm">
                <input type="hidden" name="patientId" value="<%= patientId %>">
                
                <div class="form-group">
                    <label for="fullName" class="required-field">Full Name</label>
                    <input type="text" id="fullName" name="fullName" required 
                           placeholder="Enter your full name" autocomplete="name">
                </div>
                
                <div class="form-group">
                    <label for="phoneNumber" class="required-field">Phone Number</label>
                    <input type="tel" id="phoneNumber" name="phoneNumber" required 
                           placeholder="Enter your phone number" autocomplete="tel">
                </div>
                
                <div class="form-group">
                    <label for="dateOfBirth" class="required-field">Date of Birth</label>
                    <input type="date" id="dateOfBirth" name="dateOfBirth" required 
                           max="<%= new Date().toISOString().split('T')[0] %>" autocomplete="bday">
                </div>
                
                <div class="form-group">
                    <label for="gender" class="required-field">Gender</label>
                    <select id="gender" name="gender" required autocomplete="sex">
                        <option value="">Select Gender</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="address">Address (Optional)</label>
                    <textarea id="address" name="address" rows="3" 
                              placeholder="Enter your address" autocomplete="street-address"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="emergencyContact">Emergency Contact (Optional)</label>
                    <input type="text" id="emergencyContact" name="emergencyContact" 
                           placeholder="Name and phone number">
                </div>
                
                <div class="modal-actions">
                    <button type="submit" class="btn-save" id="submitProfileBtn">
                        <span class="btn-text">Complete Profile</span>
                    </button>
                </div>
            </form>
            
            <div id="formMessage" style="display: none;"></div>
        </div>
    </div>
<% } %>

<!-- Medical Info Edit Modal -->
<div class="modal-overlay" id="medicalModal"
     data-blood-type="<%= medicalInfo && medicalInfo.bloodType ? medicalInfo.bloodType : '' %>"
     data-allergies="<%= medicalInfo && medicalInfo.allergies ? medicalInfo.allergies : '' %>"
     data-height="<%= medicalInfo && medicalInfo.height ? medicalInfo.height : '' %>"
     data-weight="<%= medicalInfo && medicalInfo.weight ? medicalInfo.weight : '' %>"
     data-chronic-conditions="<%= medicalInfo && medicalInfo.chronicConditions ? medicalInfo.chronicConditions : '' %>">
    <div class="modal-content">
        <div class="modal-header">
            <h2>üè• Edit Medical Information</h2>
            <button class="close-modal" id="closeMedicalModal">√ó</button>
        </div>
        <form id="medicalForm">
            <input type="hidden" name="patientId" value="<%= patientId %>">
            
            <div class="form-group">
                <label for="bloodType">Blood Type</label>
                <select id="bloodType" name="bloodType">
                    <option value="">Select Blood Type</option>
                    <option value="A+">A+</option>
                    <option value="A-">A-</option>
                    <option value="B+">B+</option>
                    <option value="B-">B-</option>
                    <option value="AB+">AB+</option>
                    <option value="AB-">AB-</option>
                    <option value="O+">O+</option>
                    <option value="O-">O-</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="allergies">Allergies</label>
                <textarea id="allergies" name="allergies" rows="3" 
                          placeholder="List any allergies (separate with commas)"></textarea>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="height">Height (cm)</label>
                    <input type="number" id="height" name="height" 
                           placeholder="Enter height in cm" min="50" max="250" step="0.1">
                </div>
                <div class="form-group">
                    <label for="weight">Weight (kg)</label>
                    <input type="number" id="weight" name="weight" 
                           placeholder="Enter weight in kg" min="10" max="300" step="0.1">
                </div>
            </div>
            
            <div class="form-group">
                <label for="chronicConditions">Chronic Conditions</label>
                <textarea id="chronicConditions" name="chronicConditions" rows="3" 
                          placeholder="List any chronic medical conditions"></textarea>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn-cancel" id="cancelMedical">Cancel</button>
                <button type="submit" class="btn-save" id="submitMedicalBtn">
                    <span class="btn-text">Save Medical Info</span>
                </button>
            </div>
        </form>
        
        <div id="medicalFormMessage" style="display: none;"></div>
    </div>
</div>

<!-- Personal Info Edit Modal -->
<div class="modal-overlay" id="personalModal"
     data-full-name="<%= personalInfo && personalInfo.fullName ? personalInfo.fullName : '' %>"
     data-phone-number="<%= personalInfo && personalInfo.phoneNumber ? personalInfo.phoneNumber : '' %>"
     data-date-of-birth="<%= personalInfo && personalInfo.dateOfBirth ? personalInfo.dateOfBirth : '' %>"
     data-gender="<%= personalInfo && personalInfo.gender ? personalInfo.gender : '' %>"
     data-address="<%= personalInfo && personalInfo.address ? personalInfo.address : '' %>"
     data-emergency-contact="<%= personalInfo && personalInfo.emergencyContact ? personalInfo.emergencyContact : '' %>">
    <div class="modal-content">
        <div class="modal-header">
            <h2>‚úèÔ∏è Edit Personal Information</h2>
            <button class="close-modal" id="closePersonalModal">√ó</button>
        </div>
        <form id="personalForm">
            <input type="hidden" name="patientId" value="<%= patientId %>">
            
            <div class="form-group">
                <label for="editFullName" class="required-field">Full Name</label>
                <input type="text" id="editFullName" name="fullName" required 
                       placeholder="Enter your full name" autocomplete="name">
            </div>
            
            <div class="form-group">
                <label for="editPhoneNumber" class="required-field">Phone Number</label>
                <input type="tel" id="editPhoneNumber" name="phoneNumber" required 
                       placeholder="Enter your phone number" autocomplete="tel">
            </div>
            
            <div class="form-group">
                <label for="editDateOfBirth" class="required-field">Date of Birth</label>
                <input type="date" id="editDateOfBirth" name="dateOfBirth" required 
                       max="<%= new Date().toISOString().split('T')[0] %>" autocomplete="bday">
            </div>
            
            <div class="form-group">
                <label for="editGender" class="required-field">Gender</label>
                <select id="editGender" name="gender" required autocomplete="sex">
                    <option value="">Select Gender</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="editAddress">Address (Optional)</label>
                <textarea id="editAddress" name="address" rows="3" 
                          placeholder="Enter your address" autocomplete="street-address"></textarea>
            </div>
            
            <div class="form-group">
                <label for="editEmergencyContact">Emergency Contact (Optional)</label>
                <input type="text" id="editEmergencyContact" name="emergencyContact" 
                       placeholder="Name and phone number">
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn-cancel" id="cancelPersonal">Cancel</button>
                <button type="submit" class="btn-save" id="submitPersonalBtn">
                    <span class="btn-text">Update Personal Info</span>
                </button>
            </div>
        </form>
        
        <div id="personalFormMessage" style="display: none;"></div>
    </div>
</div>

 <!-- Logout Confirmation Modal -->
<div class="modal-overlay logout-modal" id="logoutModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>üîê Confirm Logout</h2>
            <button class="close-modal" id="closeLogoutModal">√ó</button>
        </div>
        
        <div class="logout-icon">üö™</div>
        
        <p class="logout-message">
            Are you sure you want to logout from your MediDiag account?<br>
            <small>You'll need to login again to access your profile.</small>
        </p>
        
        <div class="logout-actions">
            <button class="btn-stay" id="cancelLogout">
                Stay Logged In
            </button>
            <button class="btn-logout" id="confirmLogout">
                <span>Yes, Logout</span>
            </button>
        </div>
    </div>
</div>

    <!-- JavaScript Files -->
    <script src="/patient/js/patient-navbar.js"></script>
    <script src="/patient/js/logout-modal.js"></script>

        <!-- Medical Modal JavaScript - Always load this -->
    <script src="/patient/js/medical-modal.js"></script>
    <script src="/patient/js/personal-modal.js"></script>
    
    <!-- First Login Modal JavaScript - Only loaded on first login -->
    <% if (isFirstLogin) { %>
        <script src="/patient/js/first-login-modal.js"></script>
    <% } %>

<script>
    // Store patientId for use in JavaScript
    const patientId = '<%= patientId %>';
    const isFirstLogin = <%= isFirstLogin %>;
    const hasPersonalInfo = <%= personalInfo ? true : false %>;
    console.log('first login is : ', isFirstLogin);
    console.log('has personal info:', hasPersonalInfo);

    // Blur background when modals are open
    function blurBackground() {
        document.getElementById('contentContainer').classList.add('blurred');
    }

    function unblurBackground() {
        console.log('removing blur inside unblur background function');
        document.getElementById('contentContainer').classList.remove('blurred');
    }

    // Edit profile buttons functionality
document.addEventListener('DOMContentLoaded', function() {
    const editButtons = ['editProfileBtn', 'editPersonalBtn', 'editMedicalBtn'];

    editButtons.forEach(btnId => {
        const btn = document.getElementById(btnId);
        if (btn) {
            btn.addEventListener('click', function() {
                console.log('Edit button clicked:', btnId);
                
                if (!hasPersonalInfo) {
                    alert('Please complete your personal profile first!');
                    return;
                }
                
                // Handle different edit buttons
                if (btnId === 'editMedicalBtn') {
                    console.log('Opening medical modal');
                    if (typeof showMedicalModal === 'function') {
                        showMedicalModal();
                    }
                } else if (btnId === 'editPersonalBtn' || btnId === 'editProfileBtn') {
                    console.log('Opening personal modal');
                    if (typeof showPersonalModal === 'function') {
                        showPersonalModal();
                    }
                }
            });
        }
    });

    // Auto-blur background if first login modal is active
    if (isFirstLogin) {
        blurBackground();
    } else {
        console.log('removed blur');
        unblurBackground();
    }
});


</script>
</body>
</html>